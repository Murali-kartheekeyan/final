<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Learning Platform</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons for UI elements -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Base styles */
        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        main {
            transition: margin-right 0.4s ease-in-out;
        }

        /* Side Panel Styles */
        .side-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            max-width: 500px; /* Max width for larger screens */
            height: 100%;
            background-color: white;
            box-shadow: -10px 0 25px rgba(0,0,0,0.1);
            transform: translateX(100%);
            transition: transform 0.4s ease-in-out;
            z-index: 50;
            display: flex;
            flex-direction: column;
        }
        .side-panel.open {
            transform: translateX(0);
        }
        
        /* Main content push effect */
        body.panel-open main {
            margin-right: 500px; /* Should match panel width */
        }
        @media (max-width: 768px) {
             .side-panel {
                max-width: 100%;
             }
             body.panel-open main {
                margin-right: 0; /* No push on smaller screens */
             }
        }

        /* Modal Styles */
        .modal {
            animation: fadeIn 0.3s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .prose strong {
            font-weight: 600;
        }
        /* ✨ New Style for scrollable quiz content */
        .quiz-content {
            max-height: 60vh;
            overflow-y: auto;
            padding-right: 1rem; /* For scrollbar spacing */
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">

    <!-- Header Section -->
    <header class="bg-white shadow-sm p-4 flex justify-between items-center w-full z-10">
        <div class="flex items-center gap-4">
            <button class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                <i data-lucide="arrow-left" class="text-gray-600"></i>
            </button>
            <h1 id="course-title" class="text-xl font-semibold text-gray-800">Fundamentals of Javascript</h1>
        </div>
        <div class="flex items-center gap-2 md:gap-4">
            <button id="open-ide-btn" class="flex items-center gap-2 px-3 py-2 bg-gray-700 text-white rounded-full hover:bg-gray-800 transition-all duration-300 shadow-md transform hover:scale-105">
                <i data-lucide="code-2" class="w-5 h-5"></i>
                <span class="font-medium hidden md:inline">Open IDE</span>
            </button>
            <button id="ask-ai-btn" class="flex items-center gap-2 px-3 py-2 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition-all duration-300 shadow-lg transform hover:scale-105">
                <i data-lucide="sparkles" class="w-5 h-5 text-yellow-300"></i>
                <span class="font-medium hidden md:inline">Ask AI</span>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="w-full max-w-4xl p-4 md:p-8 flex-grow flex flex-col mx-auto">
        <div class="w-full bg-gray-200 rounded-full h-2.5 my-4">
            <div id="progress-bar" class="bg-green-500 h-2.5 rounded-full transition-all duration-500 ease-out" style="width: 10%;"></div>
        </div>
        
        <div class="relative w-full aspect-video bg-gray-200 rounded-xl shadow-lg overflow-hidden">
            <img id="course-image" src="" alt="Course Content" class="w-full h-full object-cover">
        </div>

        <div class="mt-4 w-full flex flex-col items-center gap-4">
             <!-- ✨ Feature: Summarize Slide Button -->
            <button id="summarize-slide-btn" class="flex items-center gap-2 px-4 py-2 bg-teal-500 text-white rounded-full hover:bg-teal-600 transition-all duration-300 shadow-md transform hover:scale-105">
                <i data-lucide="file-text" class="w-5 h-5"></i>
                <span>✨ Summarize Slide</span>
            </button>

            <div id="timer-display" class="text-center p-2 rounded-lg"></div>
            <div id="completion-message" class="hidden text-center p-3 rounded-lg bg-yellow-100 text-yellow-800 font-semibold">
                Congratulations! You've completed the course. Ready for a quiz?
            </div>
             <button id="take-quiz-btn" class="hidden mt-2 px-6 py-3 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 transition-colors shadow-lg">
                Take Quiz
            </button>
            <div class="flex justify-between w-full mt-4">
                <button id="prev-btn" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors disabled:bg-gray-100 disabled:text-gray-400">Previous</button>
                <button id="next-btn" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors disabled:bg-indigo-300">Next</button>
            </div>
        </div>
        
        <div class="text-center mt-4 text-gray-500">
            <p id="slide-counter"></p>
        </div>
    </main>

    <!-- AI Side Panel -->
    <div id="ai-panel" class="side-panel">
        <div class="flex items-center justify-between p-4 border-b">
            <h2 class="text-xl font-bold text-gray-800">Ask AI</h2>
            <button id="close-ai-panel-btn" class="p-2 rounded-full hover:bg-gray-200"><i data-lucide="x"></i></button>
        </div>
        <div class="p-4 flex-grow overflow-y-auto">
            <p id="ai-panel-context" class="text-sm text-gray-500 mb-4"></p>
            <div id="ai-panel-content"></div>
            <div id="further-reading-container" class="mt-6 border-t pt-4"></div>
        </div>
        <div class="p-4 border-t">
            <textarea id="ai-question-input" placeholder="e.g., Explain 'hoisting' in Javascript..." class="w-full h-24 p-3 border rounded-lg"></textarea>
            <button id="ai-submit-btn" class="w-full mt-2 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700">Submit</button>
        </div>
    </div>

    <!-- IDE Side Panel -->
    <div id="ide-panel" class="side-panel">
        <div class="flex items-center justify-between p-4 border-b">
            <h2 class="text-xl font-bold text-gray-800">Code IDE</h2>
            <button id="close-ide-panel-btn" class="p-2 rounded-full hover:bg-gray-200"><i data-lucide="x"></i></button>
        </div>
        <div class="p-4 flex flex-col flex-grow">
            <select id="language-selector" class="w-full p-2 border rounded-lg mb-4">
                <option value="python">Python</option>
                <option value="javascript">JavaScript</option>
                <option value="java">Java</option>
                <option value="c++">C++</option>
                <option value="c">C</option>
            </select>
            <textarea id="code-editor" class="w-full flex-grow p-3 border rounded-lg font-mono text-sm" placeholder="Write your code here..."></textarea>
            <div class="flex gap-2 mt-4">
                <button id="run-code-btn" class="w-full py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 flex items-center justify-center gap-2">
                    <i data-lucide="play"></i> Run Code
                </button>
                <button id="explain-code-btn" class="w-full py-3 bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700 flex items-center justify-center gap-2">
                    <i data-lucide="book-open-text"></i> ✨ Explain Code
                </button>
            </div>
            <div class="mt-4 flex-grow overflow-y-auto border-t pt-4">
                <h3 class="font-semibold mb-2">Output:</h3>
                <pre id="code-output" class="bg-gray-900 text-white text-sm p-4 rounded-lg h-48 overflow-y-auto whitespace-pre-wrap"></pre>
            </div>
        </div>
    </div>
    
    <!-- Generic Modal for Summaries and Quizzes -->
    <div id="generic-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
        <div id="generic-modal-container" class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl p-6 relative flex flex-col max-h-[90vh] modal">
            <!-- Content will be injected here -->
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA AND CONSTANTS ---
            const courseModules = [
                { title: 'Introduction to Javascript', imageUrl: 'https://i.postimg.cc/yYCczG2T/1.png' },
                { title: 'Javascript Data Types', imageUrl: 'https://i.postimg.cc/HsjDdS5V/4.png ' },
                { title: 'Basic Programs & Syntax', imageUrl: 'https://i.postimg.cc/wBpGyFt5/5.png ' },
                { title: 'Function Declarations', imageUrl: 'https://i.postimg.cc/wvb2VkBG/6.png' },
                { title: 'Course Conclusion', imageUrl: 'https://i.postimg.cc/L5tTpFTr/7.png' },
            ];
            const TIMER_DURATION = 3;

            // --- STATE ---
            let currentImageIndex = 0;
            let timeRemaining = TIMER_DURATION;
            let isTimerActive = true;
            let timerInterval;
            let quizData = [];

            // --- DOM ELEMENT REFERENCES ---
            const body = document.body;
            const header = document.querySelector('header');
            const main = document.querySelector('main');
            const progressBar = document.getElementById('progress-bar');
            const courseImage = document.getElementById('course-image');
            const timerDisplay = document.getElementById('timer-display');
            const completionMessage = document.getElementById('completion-message');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const slideCounter = document.getElementById('slide-counter');
            const takeQuizBtn = document.getElementById('take-quiz-btn');
            const summarizeSlideBtn = document.getElementById('summarize-slide-btn');

            // Panels
            const aiPanel = document.getElementById('ai-panel');
            const askAiBtn = document.getElementById('ask-ai-btn');
            const closeAiPanelBtn = document.getElementById('close-ai-panel-btn');
            const aiPanelContext = document.getElementById('ai-panel-context');
            const aiPanelContent = document.getElementById('ai-panel-content');
            const aiQuestionInput = document.getElementById('ai-question-input');
            const aiSubmitBtn = document.getElementById('ai-submit-btn');
            const furtherReadingContainer = document.getElementById('further-reading-container');

            const idePanel = document.getElementById('ide-panel');
            const openIdeBtn = document.getElementById('open-ide-btn');
            const closeIdePanelBtn = document.getElementById('close-ide-panel-btn');
            const languageSelector = document.getElementById('language-selector');
            const codeEditor = document.getElementById('code-editor');
            const runCodeBtn = document.getElementById('run-code-btn');
            const explainCodeBtn = document.getElementById('explain-code-btn');
            const codeOutput = document.getElementById('code-output');
            
            const genericModal = document.getElementById('generic-modal');
            const genericModalContainer = document.getElementById('generic-modal-container');

            // --- GEMINI API FUNCTION ---
            const callGeminiAPI = async (prompt, loadingElement = null) => {
                const apiKey = "AIzaSyAd-ReC74i1FhKHKyAJ1LCN-iirmrHZrTE"; // Injected by environment
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                
                if(loadingElement) setLoading(loadingElement, true);
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    const result = await response.json();
                    return result.candidates?.[0]?.content?.parts?.[0]?.text;
                } catch (error) {
                    console.error("Gemini API call failed:", error);
                    return "Sorry, an error occurred. Please try again.";
                } finally {
                    if(loadingElement) setLoading(loadingElement, false);
                }
            };

            // --- UI & CORE LOGIC ---
            const updateUI = () => {
                const module = courseModules[currentImageIndex];
                courseImage.src = module.imageUrl;
                courseImage.alt = module.title;
                slideCounter.textContent = `Slide ${currentImageIndex + 1}/${courseModules.length}: ${module.title}`;
                progressBar.style.width = `${((currentImageIndex + 1) / courseModules.length) * 100}%`;
                prevBtn.disabled = currentImageIndex === 0;
                nextBtn.disabled = isTimerActive || currentImageIndex === courseModules.length - 1;

                if (currentImageIndex === courseModules.length - 1) {
                    timerDisplay.classList.add('hidden');
                    completionMessage.classList.remove('hidden');
                    takeQuizBtn.classList.remove('hidden');
                } else {
                    timerDisplay.classList.remove('hidden');
                    completionMessage.classList.add('hidden');
                    takeQuizBtn.classList.add('hidden');
                }
            };
            
            const setLoading = (element, isLoading) => {
                if (isLoading) {
                    element.innerHTML = `<div class="flex items-center justify-center p-8"><i data-lucide="loader-circle" class="animate-spin w-8 h-8 text-blue-500"></i></div>`;
                } else {
                    element.innerHTML = '';
                }
                lucide.createIcons();
            };
            
            const showModal = (title, content) => {
                genericModalContainer.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">${title}</h2>
                        <button id="close-generic-modal-btn" class="p-2 rounded-full hover:bg-gray-200"><i data-lucide="x"></i></button>
                    </div>
                    <div class="prose max-w-none">${content}</div>
                `;
                genericModal.classList.remove('hidden');
                lucide.createIcons();
                document.getElementById('close-generic-modal-btn').addEventListener('click', () => genericModal.classList.add('hidden'));
            };

            // --- TIMER LOGIC ---
            const startTimer = () => {
                if (currentImageIndex === courseModules.length - 1) { isTimerActive = false; updateUI(); return; }
                isTimerActive = true;
                timeRemaining = TIMER_DURATION;
                updateTimerDisplay();
                timerInterval = setInterval(() => {
                    timeRemaining--;
                    updateTimerDisplay();
                    if (timeRemaining <= 0) {
                        clearInterval(timerInterval);
                        isTimerActive = false;
                        updateUI();
                        updateTimerDisplay();
                    }
                }, 1000);
            };

            const updateTimerDisplay = () => {
                timerDisplay.className = 'text-center p-2 rounded-lg font-bold';
                if (isTimerActive) {
                    timerDisplay.classList.add('bg-red-100', 'text-red-700');
                    timerDisplay.innerHTML = `Next slide unlocks in: <span>${timeRemaining}s</span>`;
                } else {
                    timerDisplay.classList.add('bg-green-100', 'text-green-700');
                    timerDisplay.textContent = `You can proceed!`;
                }
            };
            
            // --- NAVIGATION ---
            const navigate = (direction) => {
                const newIndex = currentImageIndex + direction;
                if (newIndex >= 0 && newIndex < courseModules.length) {
                    currentImageIndex = newIndex;
                    updateUI();
                    clearInterval(timerInterval);
                    startTimer();
                }
            };
            
            // --- SIDE PANEL LOGIC ---
            const togglePanel = (panelToOpen) => {
                const allPanels = [aiPanel, idePanel];
                let isOpeningNew = !panelToOpen.classList.contains('open');
                
                allPanels.forEach(p => p.classList.remove('open'));
                
                if (isOpeningNew) {
                    panelToOpen.classList.add('open');
                    body.classList.add('panel-open');
                } else {
                    body.classList.remove('panel-open');
                }
            };

            // --- FEATURE LOGIC ---
            const handleSummarizeSlide = async () => {
                const module = courseModules[currentImageIndex];
                showModal('✨ Slide Summary', '<div id="summary-loading"></div>');
                const loadingDiv = document.getElementById('summary-loading');
                const prompt = `Provide a concise, easy-to-understand summary (2-3 sentences) for a presentation slide titled "${module.title}" in a "Fundamentals of Javascript" course.`;
                const summary = await callGeminiAPI(prompt, loadingDiv);
                showModal(`✨ Summary: ${module.title}`, summary);
            };

            const handleExplainCode = async () => {
                const language = languageSelector.value;
                const code = codeEditor.value;
                if (!code.trim()) { codeOutput.textContent = "Please write some code to explain."; return; }
                
                const prompt = `You are a code explanation engine. Provide a detailed, line-by-line explanation for the following ${language} code. Use markdown for formatting. Code:\n\n${code}`;
                codeOutput.innerHTML = '';
                const result = await callGeminiAPI(prompt, codeOutput);
                let formattedResult = result.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/`([^`]+)`/g, '<code class="bg-gray-200 text-red-500 px-1 rounded">$1</code>').replace(/\n/g, '<br>');
                codeOutput.innerHTML = formattedResult;
            };
            
            const handleFurtherReading = async (question, answer) => {
                furtherReadingContainer.innerHTML = '';
                setLoading(furtherReadingContainer, true);
                const prompt = `Based on the following question and answer about Javascript, suggest 3 related topics for further reading. For each topic, provide a one-sentence description. Question: "${question}" Answer: "${answer}"`;
                const result = await callGeminiAPI(prompt);
                setLoading(furtherReadingContainer, false);
                let formattedResult = result.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
                furtherReadingContainer.innerHTML = `<h4 class="font-bold mb-2">✨ For Further Reading:</h4><div class="prose prose-sm max-w-none">${formattedResult}</div>`;
            };

            const handleRunCode = async () => {
                const language = languageSelector.value;
                const code = codeEditor.value;
                if (!code.trim()) { codeOutput.textContent = "Please write some code first."; return; }
                
                const prompt = `You are a code execution engine. Analyze the following ${language} code, provide a brief, one-sentence explanation of what it does, and then provide its exact output. Format the response with "Explanation:" on one line, and "Output:" on the next, followed by the code's output. Code:\n\n${code}`;
                codeOutput.innerHTML = '';
                const result = await callGeminiAPI(prompt, codeOutput);
                codeOutput.textContent = result;
            };

            const handleAskAI = async () => {
                const question = aiQuestionInput.value.trim();
                if (!question) return;
                aiPanelContext.textContent = `Context: ${courseModules[currentImageIndex].title}`;
                furtherReadingContainer.innerHTML = '';
                
                const prompt = `You are a helpful AI assistant for a Javascript course. A student is on the module "${courseModules[currentImageIndex].title}" and asks: "${question}". Provide a clear, plain-text answer.`;
                const result = await callGeminiAPI(prompt, aiPanelContent);
                aiPanelContent.innerHTML = `<div class="prose max-w-none">${result.replace(/\n/g, '<br>')}</div>`;
                aiQuestionInput.value = '';
                
                handleFurtherReading(question, result);
            };
            
            // --- QUIZ LOGIC ---
            const handleTakeQuiz = async () => {
                showModal('Generating Quiz...', '<div id="quiz-loading"></div>');
                const loadingDiv = document.getElementById('quiz-loading');
                const prompt = `Generate a 5-question multiple-choice quiz on the topic of "Fundamentals of Javascript". Provide the output as a valid JSON array. Each object in the array must have a "question" key (string), an "options" key (an array of 4 strings), and a "correctAnswerIndex" key (an integer from 0 to 3).`;
                let result = await callGeminiAPI(prompt, loadingDiv);
                
                try {
                    const jsonMatch = result.match(/\[[\s\S]*\]/);
                    if (!jsonMatch) throw new Error("No valid JSON array found in the AI response.");
                    quizData = JSON.parse(jsonMatch[0]);
                    displayQuiz();
                } catch (e) {
                    console.error("Quiz JSON parsing error:", e, "Raw response:", result);
                    showModal('Error', '<p>Could not generate the quiz. The AI response was not in the correct format. Please try again.</p>');
                }
            };

            const displayQuiz = () => {
                // ✨ Changed: Added a scrollable container for quiz questions
                let quizHTML = `<div class="quiz-content space-y-6">`;
                quizData.forEach((q, index) => {
                    quizHTML += `
                        <div>
                            <p class="font-semibold mb-2">${index + 1}. ${q.question}</p>
                            <div class="space-y-2">
                                ${q.options.map((opt, i) => `
                                    <div>
                                        <input type="radio" name="question-${index}" id="q${index}-opt${i}" value="${i}" class="mr-2">
                                        <label for="q${index}-opt${i}">${opt}</label>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                });
                quizHTML += `</div><div class="mt-8 border-t pt-4"><button id="submit-quiz-btn" class="w-full px-6 py-3 bg-green-600 text-white font-bold rounded-lg">Submit Answers</button></div>`;
                showModal('Javascript Quiz', quizHTML);
                document.getElementById('submit-quiz-btn').addEventListener('click', handleSubmitQuiz);
            };
            
            const handleSubmitQuiz = () => {
                let score = 0;
                quizData.forEach((q, index) => {
                    const selected = document.querySelector(`input[name="question-${index}"]:checked`);
                    if (selected && parseInt(selected.value) === q.correctAnswerIndex) {
                        score++;
                    }
                });
                // ✨ Changed: Added "End Course" button to results
                const resultHTML = `
                    <div class="text-center p-8">
                        <h2 class="text-3xl font-bold mb-4">Quiz Complete!</h2>
                        <p class="text-xl">You scored</p>
                        <p class="text-6xl font-bold my-4 text-purple-600">${score} / ${quizData.length}</p>
                        <button id="end-course-btn" class="mt-6 px-8 py-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition-colors">End Course</button>
                    </div>
                `;
                showModal('Quiz Results', resultHTML);
                document.getElementById('end-course-btn').addEventListener('click', handleEndCourse);
            };

            // ✨ New Function: Ends the course session
            const handleEndCourse = () => {
                header.style.display = 'none';
                main.style.display = 'none';
                genericModal.classList.add('hidden');
                body.innerHTML = `
                    <div class="w-screen h-screen flex flex-col items-center justify-center bg-gray-100 text-center p-4">
                        <h1 class="text-4xl font-bold text-gray-800 mb-4">Thank you for completing the course!</h1>
                        <p class="text-lg text-gray-600">You can now safely close this page.</p>
                        <i data-lucide="party-popper" class="w-16 h-16 text-purple-500 mt-8"></i>
                    </div>
                `;
                lucide.createIcons();
            };

            // --- EVENT LISTENERS ---
            nextBtn.addEventListener('click', () => navigate(1));
            prevBtn.addEventListener('click', () => navigate(-1));
            takeQuizBtn.addEventListener('click', handleTakeQuiz);
            summarizeSlideBtn.addEventListener('click', handleSummarizeSlide);
            
            askAiBtn.addEventListener('click', () => togglePanel(aiPanel));
            closeAiPanelBtn.addEventListener('click', () => togglePanel(aiPanel));
            openIdeBtn.addEventListener('click', () => togglePanel(idePanel));
            closeIdePanelBtn.addEventListener('click', () => togglePanel(idePanel));
            
            aiSubmitBtn.addEventListener('click', handleAskAI);
            runCodeBtn.addEventListener('click', handleRunCode);
            explainCodeBtn.addEventListener('click', handleExplainCode);

            // --- INITIALIZATION ---
            lucide.createIcons();
            updateUI();
            startTimer();
        });
    </script>
</body>
</html>
